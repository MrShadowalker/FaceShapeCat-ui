import{d as Ke,f as T,e as te,p as ae,r as Ue,n as Y,I as Ve,Y as b,a6 as B,ab as z,ae as He,a9 as m,k as r,E as R,a7 as le,F as Ye,aa as ze,ad as Ge,Z as oe,ac as ie}from"./tinymce-vendor-3c2b3d6e.js";import{l as Ze,C as We,K as Xe,r as et,E as tt}from"./index-37448b2d.js";import{B as at}from"./index-64ecc8b2.js";import"./index-09260ce4.js";import{ap as v,C as lt,bx as N,bs as ot}from"./jeecg-online-vendor-f57c6456.js";import{I as it}from"./useSchemas-0433a403-d91fb803.js";import nt from"./DBAttributeTable-370de07b-23ad5221.js";import rt from"./PageAttributeTable-965dc58e-4b49e78d.js";import st from"./CheckDictTable-134cbb83-42b310dd.js";import dt from"./ForeignKeyTable-6a843c4b-7cd9260e.js";import ut from"./IndexTable-f8af9d44-66e178dd.js";import ct from"./QueryTable-eb9a5b21-d08f2506.js";import mt from"./ExtendConfigModal-1dde390a-8ab8fa59.js";import{y as bt,m as pt,c as ft,r as _}from"./cgform.data-cbdd88c3-c388dc24.js";import{J as gt}from"./useOnlineTest-e4bd8be3-90aac6cd.js";import{D as Tt}from"./useExtendComponent-325fe3f1-007b9393.js";import{B as yt,u as vt}from"./useForm-df7d93c5.js";import"./antd-vue-vendor-05bfa84d.js";import"./vxe-table-vendor-26792376.js";import"./BasicModal-9d388b71.js";import"./useWindowSizeFn-e63bb4b0.js";import"./componentMap-e2e33057.js";import"./useFormItem-613b6d5d.js";import"./index-2ad3f236.js";import"./download-2caf3e60.js";import"./base64Conver-fa2fe1af.js";import"./index-ee632f67.js";import"./index-b5f97370.js";import"./useCountdown-d833a954.js";import"./useFormItemSingle-4fd81116.js";import"./JAddInput-a2153936.js";import"./areaDataUtil-10873080.js";import"./data-9be677e2.js";import"./useSelectBiz-b5c21498.js";import"./props-ea47501e.js";import"./JSelectBiz-b887fca6.js";import"./index-2d7d6454.js";import"./htmlmixed-6ab39e30.js";import"./codemirror-vendor-0a03fef5.js";import"./vue-41a95ea0.js";/* empty css             */import"./anyword-hint-577f8e6e.js";import"./index-d4a67b72.js";import"./bem-a6e46c9e.js";import"./props-3977d3d5.js";import"./useContextMenu-3e9e42e0.js";import"./depart.api-76b2f38a.js";import"./JSelectUser-6efbe652.js";import"./JImageUpload-1b0b2e46.js";import"./JDictSelectTag-f0227cc5.js";import"./CompTypeEnum-5c91fd88.js";import"./JSelectDept-073e3b74.js";import"./useTreeBiz-a3326efb.js";import"./JEditor-75d90eae.js";import"./index-13e7f179.js";import"./JPopup-8248ac78.js";import"./cron-parser-vendor-a4cfb0b0.js";import"./JTreeSelect-73cfd2cd.js";import"./JEllipsis-242e7bd0.js";import"./JUpload-70acb676.js";import"./index-76418551.js";import"./JSearchSelect-4158b9a9.js";import"./index-3dc0c4fd.js";import"./index-aba90786.js";import"./validator-a0d2ebc7.js";import"./user.api-367a7bce.js";import"./useTableSync-774c3774-38b18ab1.js";import"./LinkTableConfigModal-d4fbdef2-437c6fa4.js";import"./LinkTableFieldConfigModal-787bc55c-01754e67.js";import"./FieldExtendJsonModal-a70a9ccd-106bfedd.js";import"./constant-754f1a9d-eadfd1e1.js";import"./index-8e09cdad.js";import"./customExpression-b2f1ff9b.js";import"./index-0f0d0317.js";import"./BasicTable-400bb95b.js";import"./injectionKey-69710956.js";import"./formUtils-09c7de86.js";import"./useListPage-66651993.js";import"./LinkTableListPiece-8499a318-01ebb291.js";import"./OnlineSelectCascade-4265c95d-4cbe6ffe.js";import"./JModalTip-33c7dc44-1741a3e9.js";var ht=Object.defineProperty,Ct=Object.defineProperties,kt=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,xt=Object.prototype.hasOwnProperty,Dt=Object.prototype.propertyIsEnumerable,re=(t,o,d)=>o in t?ht(t,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[o]=d,E=(t,o)=>{for(var d in o||(o={}))xt.call(o,d)&&re(t,d,o[d]);if(ne)for(var d of ne(o))Dt.call(o,d)&&re(t,d,o[d]);return t},Rt=(t,o)=>Ct(t,kt(o)),k=(t,o,d)=>new Promise((I,h)=>{var p=f=>{try{C(d.next(f))}catch(g){h(g)}},x=f=>{try{C(d.throw(f))}catch(g){h(g)}},C=f=>f.done?I(f.value):Promise.resolve(f.value).then(p,x);C((d=d.apply(t,o)).next())});const ol=t=>v.get({url:"/online/cgform/head/list",params:t}),il=t=>se(t,0),nl=t=>v.delete({url:"/online/cgform/head/removeRecord",params:{id:t}},{joinParamsToUrl:!0}),rl=t=>se(t,1),sl=t=>v.delete({url:"/online/cgform/head/delete",params:{id:t}},{joinParamsToUrl:!0});function se(t,o){return v.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const dl=(t,o)=>v.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"同步数据库超时，已自动刷新"}),ul=t=>v.post({url:`/online/cgform/head/copyOnline?code=${t}`}),cl=(t,o,d)=>v.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:E({tableName:o},d)}),A={doQueryField:(t,o)=>v.get({url:"/online/cgform/field/listByHeadId",params:E({headId:t},o)}),doQueryIndexes:(t,o)=>v.get({url:"/online/cgform/index/listByHeadId",params:E({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?v.put({url:"/online/cgform/api/editAll",params:t}):v.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>v.put({url:"/online/cgform/head/edit",params:t})},Ft=Ke({name:"CgformModal",components:{BasicModal:at,BasicForm:yt,DBAttributeTable:nt,PageAttributeTable:rt,CheckDictTable:st,ForeignKeyTable:dt,IndexTable:ut,QueryTable:ct,ExtendConfigModal:mt,Icon:Ze},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:d}=lt(),I=T(),h=T(!1);let p={};const x=te(()=>h.value?"编辑":"新增"),C=T(!0),f=T(!1),g=T("dbTable"),w=T(!0),u={dbTable:T(),pageTable:T(),checkTable:T(),fkTable:T(),idxTable:T(),queryTable:T()},L=te(()=>{var e,a;return(a=(e=I.value)==null?void 0:e.fullScreenRef)!=null?a:!1});ae("tables",u),ae("fullScreenRef",L);const j={value:{}},{formSchemas:Q}=it(t,j,{onTableTypeChange:Ce,onIsTreeChange:ke,ifShowOfSubTableStr:()=>Z}),[$,F]=vt({schemas:Q,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:J,setFieldsValue:O,validate:q}=F,[K,{closeModal:U}]=We(e=>{var a;h.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,h.value?W(e==null?void 0:e.record):fe()}),M=T("");let c=Ue({});const V=Xe(()=>xe(),150);let G=[],Z=!1,P=!1,D=[];const{aiTestMode:de,aiTestTable:ue,aiTableList:ce,initVirtualData:me,tableJsonGetHelper:be,refreshCacheTableName:pe}=gt();function fe(){W({})}function W(e){return k(this,null,function*(){var a;if(C.value=!1,g.value="dbTable",yield J(),p=Object.assign({},e),ve(p),be(p),ye(p),O(p),M.value=p.tableName,N(1,()=>w.value=!1),h.value)(a=u.dbTable.value)==null||a.setDataSource([]),yield ge(p.id),yield Te(p.id),Tt(u.pageTable).then(()=>{u.pageTable.value.changePageType(p.tableType==3)});else{let{initialData:l,tempIds:i}=bt();yield X(l,!0),G=i}})}function ge(e){return k(this,null,function*(){f.value=!0;try{let a=yield A.doQueryField(e);f.value=!1,yield X(a)}finally{f.value=!1}})}function Te(e){return k(this,null,function*(){let a=yield A.doQueryIndexes(e);u.idxTable.value.setDataSource(a)})}function ye(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){}c=Object.assign({},pt,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ve(e){P=e.isTree=="Y",Z=e.tableType===2}function X(e,a){return k(this,null,function*(){const{dbTable:l,pageTable:i,checkTable:s,fkTable:n,queryTable:y}=u;l.value||(yield Y(),yield N(1)),l.value.setDataSource(e,a),setTimeout(()=>{i.value.setDataSource(e,a),s.value.setDataSource(e,a),n.value.setDataSource(e,a),y.value.setDataSource(e,a)},10)})}function he(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=u.dbTable,l=u[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function Ce(e){e===1&&O({themeTemplate:"normal"}),u.pageTable.value.changePageType(e==3)}function ke(e){e==="Y"?Be():_e()}function H(){V()}function xe(){return k(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:i,queryTable:s}=u;yield a.value.syncTable(e),yield l.value.syncTable(e),yield i.value.syncTable(e),yield s.value.syncTable(e)})}function De(){H()}function Re(){H()}function Fe(e){let{oldIndex:a,newIndex:l}=e;we(a,l)}function Ie(e){return k(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:i,checkTable:s,fkTable:n,queryTable:y}=u;i.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),n.value.tableRef.insertRows(l,a),y.value.tableRef.insertRows(l,a)})}function we(e,a){let{pageTable:l,checkTable:i,fkTable:s,queryTable:n}=u;l.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a)}function Oe(e){u.pageTable.value.syncFieldShowType(e.row)}function Se(e){u.pageTable.value.enableQuery(e)}function Be(){if(!P){let{dbTable:e,pageTable:a,checkTable:l}=u,i=ft();i=i.filter(s=>!e.value.tableRef.getTableData().map(n=>n.dbFieldName).includes(s.dbFieldName)),D=[],i.forEach(s=>{let n=et()+"__tempId";D.push(n),s.id=n}),e.value.tableRef.addRows(i,{setActive:!1}),a.value.tableRef.addRows(i,{setActive:!1}),l.value.tableRef.addRows(i,{setActive:!1}),Y(()=>H()),P=!0}Y(()=>{F.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function _e(){if(D&&D.length>0){let{dbTable:e}=u;e.value.tableDeleteLines(D),D=[],P=!1}}function je(){let e={};return new Promise((a,l)=>{q().then(i=>a({values:i}),()=>l(_))}).then(a=>(Object.assign(e,a),Me())).then(a=>{Object.assign(e,a);let l=Pe(e);return Ne(l)}).catch(a=>(a===_||(a==null?void 0:a.code)===_?d.warning("校验未通过"):a!=null&&a.msg&&d.warning(a.msg),Promise.reject(null)))}function Me(){return new Promise((e,a)=>k(this,null,function*(){let l=Object.keys(u),i={};for(let s=0;s<l.length;s++){let n=l[s],y=u[n];try{i[n]=yield y.value.validateData(n)}catch(S){S.code===_&&(g.value=S.activeKey),a(S);return}}e(i)}))}function Pe(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(p,e.values),a.head.isDesForm=c.isDesForm,a.head.desFormCode=c.desFormCode,delete c.isDesForm,delete c.desFormCode,a.head.extConfigJson=JSON.stringify(c),e.dbTable.tableData.forEach((l,i)=>{let s=l.id,n=Object.assign({},l),y=e.pageTable.tableData[i];n=Object.assign(y,n);let S=e.checkTable.tableData[i];n=Object.assign(S,n);let Je=e.fkTable.tableData[i];n=Object.assign(Je,n);let qe=e.queryTable.tableData[i];n=Object.assign(qe,n),s==null||s===""?delete n.id:n.id=s,[].concat(G,D).includes(n.id)&&delete n.id,a.fields.push(n)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Ne(e){return new Promise((a,l)=>{let i=e.fields,s=!0;if(i&&i.length>0){let n=0;for(let y=0;y<i.length;y++)if((i[y].mainField||i[y].mainTable)&&(n+=1),n>1){s=!1;break}}s?a(e):l({code:-1,msg:"外键只允许配置一个!",error:_})})}function Ae(){C.value=!0,je().then(e=>k(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield A.doSaveOrUpdate(e,h.value),pe(M.value,e.head.tableName),o("success"),N(1,()=>ee())}),e=>{}).finally(()=>{C.value=!1})}const[Ee,Le]=tt();function Qe(e){return k(this,null,function*(){if(j.value=e,e.joinQuery==0&&F.validateFields(["themeTemplate"]),c=e,h.value==!0){let a=Ve(c);const l={id:p.id,extConfigJson:JSON.stringify(a)};yield A.editHead(l),o("success")}})}function $e(){Le.openModal(!0,{extConfigJson:c})}function ee(){w.value=!0,N(1,()=>U())}return Rt(E({},u),{modalRef:I,title:x,confirmLoading:C,tableLoading:f,activeKey:g,onCancel:ee,extConfigJson:c,formAction:F,hideTabs:w,onSubmit:Ae,onTabsChange:he,onTableAdded:De,onTableRemoved:Re,onTableDragged:Fe,onTableInserted:Ie,onTableSyncDbType:Oe,onTableQuery:Se,onOpenExtConfig:$e,onExtConfigOk:Qe,registerForm:$,registerModal:K,registerExtendConfigModal:Ee,aiTestMode:de,aiTestTable:ue,aiTableList:ce,initVirtualData:me})}}),It={style:{flex:"1","text-align":"right"}},wt={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function Ot(t,o,d,I,h,p){const x=b("a-button"),C=b("BasicForm"),f=b("DBAttributeTable"),g=b("a-tab-pane"),w=b("PageAttributeTable"),u=b("CheckDictTable"),L=b("ForeignKeyTable"),j=b("IndexTable"),Q=b("Icon"),$=b("a-tooltip"),F=b("QueryTable"),J=b("a-tabs"),O=b("a-spin"),q=b("a-select-option"),K=b("a-select"),U=b("ExtendConfigModal"),M=b("BasicModal");return B(),z(M,He({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:m(()=>[r(x,{onClick:t.onCancel},{default:m(()=>[R("关闭")]),_:1},8,["onClick"]),r(x,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:m(()=>[R("保存")]),_:1},8,["loading","onClick"]),t.aiTestMode?(B(),le("div",wt,[r(K,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=c=>t.aiTestTable=c),placeholder:"请选择测试的表类型",getPopupContainer:c=>c==null?void 0:c.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:m(()=>[(B(!0),le(Ye,null,ze(t.aiTableList,(c,V)=>(B(),z(q,{key:V,value:c.name},{default:m(()=>[R(Ge(c.title+"（"+c.name+"）"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(x,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:m(()=>[R("生成数据>>")]),_:1},8,["onClick"])])):oe("",!0)]),default:m(()=>[r(O,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:m(()=>[r(C,{onRegister:t.registerForm},{extConfigButton:m(()=>[ie("div",It,[r(x,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:m(()=>[R("扩展配置")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(O,{spinning:t.tableLoading||t.hideTabs},{default:m(()=>[t.hideTabs?oe("",!0):(B(),z(J,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=c=>t.activeKey=c),animated:"",onChange:t.onTabsChange},{default:m(()=>[r(g,{tab:"数据库属性",key:"dbTable",forceRender:""},{default:m(()=>[r(f,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(g,{tab:"页面属性",key:"pageTable",forceRender:""},{default:m(()=>[r(w,{ref:"pageTable"},null,512)]),_:1}),r(g,{tab:"校验字段",key:"checkTable",forceRender:""},{default:m(()=>[r(u,{ref:"checkTable"},null,512)]),_:1}),r(g,{tab:"外键",key:"fkTable",forceRender:""},{default:m(()=>[r(L,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(g,{tab:"索引",key:"idxTable",forceRender:""},{default:m(()=>[r(j,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(g,{key:"queryTable",forceRender:""},{tab:m(()=>[ie("span",null,[R(" 个性查询配置 "),r($,null,{title:m(()=>[R("允许自定义，查询表单字段控件类型！")]),default:m(()=>[r(Q,{icon:"bx:help-circle"})]),_:1})])]),default:m(()=>[r(F,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(U,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}const St=ot(Ft,[["render",Ot]]),ml=Object.freeze(Object.defineProperty({__proto__:null,default:St},Symbol.toStringTag,{value:"Module"}));export{St as C,sl as a,nl as b,il as c,ul as d,rl as e,dl as f,cl as g,ml as h,ol as l};
