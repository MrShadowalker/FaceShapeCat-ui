import{ac as C,d as se,f as V,r as F,u as g,e as de,Y as w,a6 as T,ab as R,ae as ue,a9 as h,k as y,E as N}from"./tinymce-vendor-3c2b3d6e.js";import{B as ce}from"./index-64ecc8b2.js";import"./index-09260ce4.js";import{useJvxeMethod as pe}from"./useJvxeMethods-fedaf981.js";import{aA as n,C as me}from"./index-37448b2d.js";import{d as fe}from"./user.api-367a7bce.js";import{C as H,ap as b,H as ge}from"./jeecg-online-vendor-f57c6456.js";import{u as he,B as ye}from"./useForm-df7d93c5.js";var be=Object.defineProperty,ve=Object.defineProperties,xe=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,ke=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable,D=(t,l,a)=>l in t?be(t,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[l]=a,J=(t,l)=>{for(var a in l||(l={}))ke.call(l,a)&&D(t,a,l[a]);if(A)for(var a of A(l))Se.call(l,a)&&D(t,a,l[a]);return t},we=(t,l)=>ve(t,xe(l)),W=(t,l,a)=>new Promise((v,p)=>{var f=u=>{try{d(a.next(u))}catch(k){p(k)}},x=u=>{try{d(a.throw(u))}catch(k){p(k)}},d=u=>u.done?v(u.value):Promise.resolve(u.value).then(f,x);d((a=a.apply(t,l)).next())});const{createConfirm:Ce}=H(),Ie="/online/cgreport/param/listByHeadId",Pe="/online/cgreport/item/listByHeadId",Ze=t=>b.get({url:"/online/cgreport/head/list",params:t}),Ge=(t,l)=>b.delete({url:"/online/cgreport/head/delete",params:t},{joinParamsToUrl:!0}).then(()=>{l()}),Xe=(t,l)=>{Ce({title:"确认删除",content:"是否删除选中数据",okText:"确认",cancelText:"取消",iconType:"warning",onOk:()=>b.delete({url:"/online/cgreport/head/deleteBatch",data:t},{joinParamsToUrl:!0}).then(()=>{l()})})},Ve=(t,l)=>l?b.put({url:"/online/cgreport/head/editAll",params:t}):b.post({url:"/online/cgreport/head/add",params:t}),et=t=>b.get({url:"/online/cgreport/api/getParamsInfo/"+t}),Ne=()=>b.get({url:"/sys/dataSource/options"}),$e=t=>b.get({url:"/online/cgreport/head/parseSql?"+t}),qe=ge(),tt=[{title:"报表名字",align:"center",dataIndex:"name",width:120},{title:"报表编码",align:"center",dataIndex:"code",width:120},{title:"报表SQL",align:"center",dataIndex:"cgrSql",width:360},{title:"数据源",align:"center",dataIndex:"dbSource",width:120},{title:"创建时间",align:"center",dataIndex:"createTime",width:120}],lt=[{label:"报表名称",field:"name",component:"JInput"},{label:"报表编码",field:"code",component:"JInput"}],_e=/^[a-z|A-Z][a-z|A-Z|\d|_|-]{0,}$/,Be=[{label:"",field:"id",component:"Input",show:!1},{label:"报表编码",field:"code",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:({values:t,model:l})=>[{required:!0,validator:(a,v)=>new Promise((p,f)=>{if(!v)return f("请输入报表编码！");if(!_e.test(v))return f("编码必须以字母开头，可包含数字、下划线、横杠！");let x={tableName:"onl_cgreport_head",fieldName:"code",fieldVal:v,dataId:l.id};fe(x).then(d=>{d.success?p():f("报表编码已存在!")}).catch(d=>{f(d.message||"校验失败")})})}]},{label:"报表名字",field:"name",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:()=>[{required:!0,message:"请输入报表名字!"}]},{label:"动态数据源",field:"dbSource",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},component:"ApiSelect",rules:[{required:qe.sysSafeMode,message:"请选择数据源！"}],componentProps:{api:Ne}},{label:"报表SQL",field:"cgrSql",component:"JCodeEditor",rules:[{required:!0,message:"请填写报表SQL"}],itemProps:{labelCol:{xs:24,sm:2},wrapperCol:{xs:24,sm:22}},componentProps:{height:"200px",fullScreen:!0},colProps:{span:20}},{label:" ",field:"analyseButton",component:"Input",slot:"analyseButton",colProps:{span:4},itemProps:{labelCol:{xs:1,sm:1},wrapperCol:{xs:23,sm:23},colon:!1}}],Le=[{title:"参数字段",key:"paramName",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数文本",key:"paramTxt",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数默认值",key:"paramValue",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:""}],Oe=[{title:"字段名字",key:"fieldName",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段文本",key:"fieldTxt",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段类型",key:"fieldType",minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}],type:n.select,options:[{title:"数值类型",value:"Integer"},{title:"字符类型",value:"String"},{title:"日期类型",value:"Date"},{title:"时间类型",value:"Datetime"},{title:"长整型",value:"Long"}]},{title:"是否显示",key:"isShow",minWidth:"80px",align:"center",type:n.checkbox,customValue:[1,0],defaultChecked:!0},{title:"字段href",key:"fieldHref",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"查询模式",key:"searchMode",type:n.select,minWidth:"150px",placeholder:"请选择${title}",options:[{title:"单条件查询",value:"single"},{title:"范围查询",value:"group"}]},{title:"取值表达式",key:"replaceVal",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"字典code",key:"dictCode",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"分组标题",key:"groupTitle",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"是否查询",key:"isSearch",type:n.checkbox,customValue:["1","0"],minWidth:"80px",align:"center",defaultChecked:!1},{title:"是否合计",align:"center",key:"isTotal",type:n.checkbox,customValue:["1","0"],minWidth:"80px",defaultChecked:!1}],Te={style:{flex:"1","text-align":"left"}},Re=C("br",null,null,-1),We=C("br",null,null,-1),je=C("br",null,null,-1),Me=C("br",null,null,-1),Fe=C("br",null,null,-1),Ae=C("span",{style:{color:"red"}},"注：参数只支持动态报表，popup暂不支持",-1),at=se({__name:"CgreportModal",emits:["register","success"],setup(t,{emit:l}){const{createMessage:a}=H(),v=l,p=V(!0),f=V(!0),x=V(["onlCgreportItem","onlCgreportParam"]),d=V("onlCgreportItem"),u=V(),k=V(),U={onlCgreportItem:k,onlCgreportParam:u},I=F({loading:!1,dataSource:[],columns:Le}),P=F({loading:!1,dataSource:[],columns:Oe}),[Q,{setProps:z,resetFields:E,setFieldsValue:K,validate:De,validateFields:Y}]=he({schemas:Be,showActionButtonGroup:!1}),[Z,{setModalProps:$,closeModal:G}]=me(e=>W(this,null,function*(){var r,i;yield ae(),$({confirmLoading:!1,showCancelBtn:e==null?void 0:e.showFooter,showOkBtn:e==null?void 0:e.showFooter}),p.value=!!(e!=null&&e.isUpdate),g(p)&&(yield K(J({},e.record)),j(Ie,{headId:(r=e==null?void 0:e.record)==null?void 0:r.id},I),j(Pe,{headId:(i=e==null?void 0:e.record)==null?void 0:i.id},P)),z({disabled:!(e!=null&&e.showFooter)})})),[X,ee,j,te]=pe(oe,re,U,d,x),le=de(()=>g(p)?"编辑":"新增");function ae(){return W(this,null,function*(){yield E(),d.value="onlCgreportItem",I.dataSource=[],P.dataSource=[]})}function re(e){let r=Object.assign({},e.formValue);return we(J({},r),{onlCgreportParamList:e.tablesValue[1].tableData,onlCgreportItemList:e.tablesValue[0].tableData})}function oe(e){return W(this,null,function*(){try{$({confirmLoading:!0});let r=[],i=[],s={};Object.keys(e).map(o=>{o=="onlCgreportItemList"?i=e[o]:o=="onlCgreportParamList"?r=e[o]:s[o]=e[o]}),yield Ve({head:s,params:r,items:i},p.value),G(),v("success")}finally{$({confirmLoading:!1})}})}function ie(){$({confirmLoading:!0}),Y(["cgrSql","dbSource"]).then(e=>{let{cgrSql:r,dbSource:i}=e,s="sql="+encodeURIComponent(r);i&&(s+="&dbKey="+i),$e(s).then(o=>{if(o){a.success("解析成功");let{fields:S,params:c}=o,m=S.filter(_=>_.fieldName!="__row_number__"),B=k.value.getTableData(),q=M(B,m||[],"fieldName");q=q.sort((_,O)=>_.orderNum-O.orderNum),P.dataSource=q;let ne=u.value.getTableData(),L=M(ne,c||[],"paramName");L=L.sort((_,O)=>_.orderNum-O.orderNum),I.dataSource=L}})}).catch(()=>{}).finally(()=>{$({confirmLoading:!1})})}function M(e,r,i){if(e.length>0){let s=[],o=[],S=1;for(let c of r)for(let m of e)if(m[i]==c[i]){s.push(m),o.push(c[i]),m.orderNum>S&&(S=m.orderNum);break}for(let c of r)o.indexOf(c[i])<0&&(c.orderNum=++S,s.push(c));return s}else{let s=0;for(let o of r)o.orderNum||(o.orderNum=++s);return r}}return(e,r)=>{const i=w("a-icon"),s=w("a-popover"),o=w("a-button"),S=w("a-divider"),c=w("JVxeTable"),m=w("a-tab-pane"),B=w("a-tabs");return T(),R(g(ce),ue(e.$attrs,{onRegister:g(Z),title:le.value,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:f.value,onOk:g(ee)}),{default:h(()=>[y(g(ye),{onRegister:g(Q),ref_key:"formRef",ref:te},{analyseButton:h(()=>[C("div",Te,[y(s,{title:"使用指南",trigger:"hover",style:{margin:"0 10px 0 6px"}},{content:h(()=>[N(" 您可以键入“”作为一个参数，这里abc是参数的名称。例如："),Re,N(" select * from table where id = ${abc}。"),We,N(" select * from table where id like concat('%',${abc},'%')。(mysql模糊查询)"),je,N(" select * from table where id like '%'||${abc}||'%'。(oracle模糊查询)"),Me,N(" select * from table where id like '%'+${abc}+'%'。(sqlserver模糊查询)"),Fe,Ae]),default:h(()=>[y(i,{type:"question-circle"})]),_:1}),y(o,{style:{"margin-left":"10px"},type:"primary",onClick:ie},{default:h(()=>[N("SQL解析")]),_:1})])]),_:1},8,["onRegister"]),y(S,{style:{margin:"1px 0"},class:"cust-divider"}),y(B,{activeKey:d.value,"onUpdate:activeKey":r[0]||(r[0]=q=>d.value=q),animated:"",onChange:g(X)},{default:h(()=>[(T(),R(m,{tab:"动态报表配置明细",key:x.value[0],forceRender:!0},{default:h(()=>[y(c,{"keep-source":"",dragSort:"",resizable:"",ref_key:"onlCgreportItem",ref:k,loading:P.loading,columns:P.columns,dataSource:P.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1})),(T(),R(m,{tab:"报表参数",key:x.value[1],forceRender:!0},{default:h(()=>[y(c,{"keep-source":"",resizable:"",dragSort:"",ref_key:"onlCgreportParam",ref:u,loading:I.loading,columns:I.columns,dataSource:I.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1}))]),_:1},8,["activeKey","onChange"])]),_:1},16,["onRegister","title","confirmLoading","onOk"])}}});export{Ze as Y,at as a,Ge as e,tt as l,et as o,lt as r,Xe as t};
