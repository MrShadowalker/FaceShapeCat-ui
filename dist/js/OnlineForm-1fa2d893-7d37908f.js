import{C as yt,ap as te,bx as vt,ao as Ft,bv as kt,bs as St}from"./jeecg-online-vendor-f57c6456.js";import{f as p,c as Tt,r as wt,u as ge,n as ye,I as D,e as Pt,Y as y,a6 as k,a7 as E,k as w,Z as J,ab as L,a9 as _,F as Ct,aa as Ot,ao as xt,Q as Rt}from"./tinymce-vendor-3c2b3d6e.js";import"./index-09260ce4.js";import{$ as Vt,N as jt,j as Dt,a as Mt,B as At,Z as H,D as $t,R as K,W as Bt,u as Et,U as ve}from"./useExtendComponent-325fe3f1-007b9393.js";import{br as _t,bs as Kt,ar as Nt,p as Ut,o as Fe}from"./antd-vue-vendor-05bfa84d.js";import{ae as It,E as qt}from"./index-37448b2d.js";import"./index-64ecc8b2.js";import{I as Jt,g as Lt}from"./useCustomHook-acb00837-32b1f38e.js";import{s as W}from"./constant-754f1a9d-eadfd1e1.js";import"./componentMap-e2e33057.js";import"./index-8e09cdad.js";import"./user.api-367a7bce.js";import"./customExpression-b2f1ff9b.js";import"./index-0f0d0317.js";import"./useListPage-66651993.js";import"./index-76418551.js";import"./LinkTableListPiece-8499a318-01ebb291.js";import"./OnlineSelectCascade-4265c95d-4cbe6ffe.js";import"./JModalTip-33c7dc44-1741a3e9.js";import{B as Ht,u as Wt}from"./useForm-df7d93c5.js";import"./vxe-table-vendor-26792376.js";import"./JAddInput-a2153936.js";import"./areaDataUtil-10873080.js";import"./data-9be677e2.js";import"./useFormItem-613b6d5d.js";import"./useSelectBiz-b5c21498.js";import"./props-ea47501e.js";import"./JSelectBiz-b887fca6.js";import"./index-2d7d6454.js";import"./BasicModal-9d388b71.js";import"./useWindowSizeFn-e63bb4b0.js";import"./htmlmixed-6ab39e30.js";import"./codemirror-vendor-0a03fef5.js";import"./vue-41a95ea0.js";/* empty css             */import"./anyword-hint-577f8e6e.js";import"./index-d4a67b72.js";import"./bem-a6e46c9e.js";import"./props-3977d3d5.js";import"./useContextMenu-3e9e42e0.js";import"./depart.api-76b2f38a.js";import"./JSelectUser-6efbe652.js";import"./JSelectDept-073e3b74.js";import"./useTreeBiz-a3326efb.js";import"./JPopup-8248ac78.js";import"./JEllipsis-242e7bd0.js";import"./JDictSelectTag-f0227cc5.js";import"./CompTypeEnum-5c91fd88.js";import"./JTreeSelect-73cfd2cd.js";import"./JSearchSelect-4158b9a9.js";import"./JEditor-75d90eae.js";import"./index-13e7f179.js";import"./JImageUpload-1b0b2e46.js";import"./JUpload-70acb676.js";import"./BasicTable-400bb95b.js";import"./injectionKey-69710956.js";import"./index-2ad3f236.js";import"./download-2caf3e60.js";import"./base64Conver-fa2fe1af.js";import"./index-ee632f67.js";import"./index-b5f97370.js";import"./useCountdown-d833a954.js";import"./useFormItemSingle-4fd81116.js";import"./cron-parser-vendor-a4cfb0b0.js";import"./index-3dc0c4fd.js";import"./index-aba90786.js";import"./formUtils-09c7de86.js";var zt=Object.defineProperty,ke=Object.getOwnPropertySymbols,Zt=Object.prototype.hasOwnProperty,Qt=Object.prototype.propertyIsEnumerable,Se=(r,d,i)=>d in r?zt(r,d,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[d]=i,M=(r,d)=>{for(var i in d||(d={}))Zt.call(d,i)&&Se(r,i,d[i]);if(ke)for(var i of ke(d))Qt.call(d,i)&&Se(r,i,d[i]);return r},P=(r,d,i)=>new Promise((a,R)=>{var S=f=>{try{F(i.next(f))}catch(c){R(c)}},C=f=>{try{F(i.throw(f))}catch(c){R(c)}},F=f=>f.done?a(f.value):Promise.resolve(f.value).then(S,C);F((i=i.apply(r,d)).next())});const le={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},Xt={name:"OnlineForm",components:{BasicForm:Ht,Loading:It,OnlineSubForm:Vt,PrinterOutlined:_t,DiffOutlined:Kt,FormOutlined:Nt,OnlinePopModal:jt},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0},modalClass:{type:String,default:""},themeTemplate:{type:String,default:""},subTableSource:{default:()=>({})}},emits:["success","rendered"],setup(r,{emit:d}){const{createMessage:i}=yt(),a=p(null),R=p(!0),S=p(!1),C=p(1),F=p(""),f=p(!1),c=p(!1),O=Tt("foreignkey",{value:{}}),V=wt({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:m,resetContext:z}=Dt(),{formSchemas:A,defaultValueFields:j,changeDataIfArray2String:N,tableName:u,dbData:v,checkOnlyFieldValue:h,hasSubTable:Te,subTabInfo:$,refMap:Z,subDataSource:U,baseColProps:we,createFormSchemas:Pe,linkDownList:ll,fieldDisplayStatus:B}=Mt(r,a);let{EnhanceJS:s,initCgEnhanceJs:Ce}=At(m,!1);const{executeJsEnhanced:Oe}=Jt({},m),[xe,{setProps:Re,validate:oe,resetFields:ne,setFieldsValue:T,updateSchema:Q,getFieldsValue:X,scrollToField:Ve}]=Wt({schemas:A,showActionButtonGroup:!1,baseColProps:we}),ae=p(!1);function je(){let e=r.disabled;ae.value=e,Re({disabled:e})}function De(e,t,l){return P(this,null,function*(){yield Me(),F.value="",yield ne(),v.value="";let o=ge(e);c.value=o,o?yield re(t):ue(),ye(()=>{!o&&l&&T(l),Ae(),Y("js","loaded"),je()})})}function Me(){return P(this,null,function*(){if(r.isTree===!0){let e=r.pidField,t=A.value;t&&t.length>0&&t.filter(l=>l.field===e).length>0&&(yield Q({field:e,componentProps:{reload:new Date().getTime()}}))}})}function Ae(){if(ge(c)===!1){let e=D(j[u.value]);H(e,t=>{T(t)})}}function ie(e,t){let l=D(j[e.key]);H(l,o=>{const{row:n,target:b}=t;let x=[{rowKey:n.id,values:M({},o)}];b.setValues(x)})}function re(e){return P(this,null,function*(){let t=yield Be(e.id);v.value=Object.assign({},e,t);let l=$e.value,o=Ut(t,...l);r.disabled&&Object.keys(o).map(n=>{!o[n]&&o[n]!==0&&o[n]!=="0"&&delete o[n]}),yield T(o),ue(t)})}function ue(e){e||(e={});let t=Object.keys(U.value);if(t&&t.length>0){let l={};for(let o of t)l[o]=e[o]||[];U.value=l}}let $e=Pt(()=>{let e=A.value,t=[];for(let l of e)t.push(l.field);return t});function Be(e){let t=`${le.optPre}${r.id}/${e}`;return new Promise((l,o)=>{te.get({url:t},{isTransformResponse:!1}).then(n=>{n.success?l(n.result):(o(),i.warning(n.message))}).catch(()=>{o()})})}function Ee(e){return P(this,null,function*(){C.value=e.head.tableType,u.value=e.head.tableName,R.value=e.head.tableType==1,Ne(e.head.extConfigJson),Pe(e.schema.properties,e.schema.required,h),s=Ce(e.enhanceJs),d("rendered",V);let t=yield $t(a);t.$formValueChange=(l,o,n)=>{lt(l,o),n&&T(n),_e(l,o,n)},s&&s.setup&&ce(s.setup)})}function _e(e,t,l){m.changEvent(e,t,l)}function Ke(e){m.addObject2Context("changEvent",e)}function Ne(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(l=>{V[l]=t[l]})}function Ue(){R.value===!0?He():Ie()}function Ie(){qe().then(e=>{se(e)})}function qe(){let e={};return new Promise((t,l)=>{oe().then(o=>t(o),({errorFields:o})=>{o&&o.length>0&&Ve(o[0][0]),l(K)})}).then(t=>(Object.assign(e,N(t)),r.themeTemplate===W?Promise.resolve({}):Le())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>((t===K||(t==null?void 0:t.code)===K)&&(i.warning("校验未通过"),t.key&&Je(t.key)),Promise.reject(null)))}function Je(e){let t=$.value;for(let l=0;l<t.length;l++)if(e==t[l].key){let o=l+"";if(I.value===o)break;if(I.value=o,t[l].relationType===0){let n=g(e);vt(300,()=>n==null?void 0:n.validateTable())}break}}function Le(){return new Promise((e,t)=>P(this,null,function*(){let l={};try{let o=$.value;for(let n=0;n<o.length;n++){let b=o[n].key,x=g(b);if(o[n].relationType==1)try{let q=yield x.getAll();l[b]=[],l[b].push(q)}catch(q){throw{code:K,key:b}}else{if(yield x.fullValidateTable())throw{code:K,key:b};l[b]=x.getTableData()}}}catch(o){t(o)}e(l)}))}function He(){return P(this,null,function*(){try{let e=yield oe();e=Object.assign({},v.value,e),e=N(e),S.value=!0,se(e)}finally{S.value=!1}})}function se(e){r.themeTemplate===W&&c.value&&Object.keys(r.subTableSource).length&&(e=M(M({},e),r.subTableSource)),at(he,e).then(()=>{We(e)}).catch(t=>{i.warning(t)})}function We(e){Object.keys(e).map(n=>{Array.isArray(e[n])&&e[n].length==0&&(e[n]="")});let t=F.value,l=`${le.optPre}${r.id}?tabletype=${C.value}`;t&&(l=`${t}?tabletype=${C.value}`),f.value===!0&&(e[Bt]=1),O.value.field&&O.value.value&&(e[O.value.field]=O.value.value);let o=c.value===!0?"put":"post";te.request({url:l,method:o,params:e},{isTransformResponse:!1}).then(n=>{n.success?(n.result&&(e[Et]=n.result),d("success",e),r.submitTip===!0&&i.success(n.message)):i.warning(n.message)}).finally(()=>{S.value=!1})}function ze(e,t,l){t&&l?l.vxeProps?l.setValues([{rowKey:t,values:e}]):l.setValues(e):T(e)}function Ze(e,t){let l={};l[e]=t,T(l)}const I=p("0"),de=p(300),me=p(340);function Qe(e){if(c.value===!0){let t=v.value;return Xe(t,e)}return""}function Xe(e,t){if(e){let l=e[t];return!l&&l!==0&&(l=e[t.toLowerCase()],!l&&l!==0&&(l=e[t.toUpperCase()])),l}return""}function Ye(e,t){if(s&&s[t+"_onlChange"]){let l=s[t+"_onlChange"](),o=Object.keys(e)[0];if(l[o]){let n=g(t).getFormEvent(),b=M({column:{key:o},value:e[o]},n);l[o].call(m,m,b)}}}function Ge(e,t){if(s&&s[t+"_onlChange"]){let l=s[t+"_onlChange"](m);if(e.column==="all"){let o=Object.keys(l);if(o.length>0)for(let n of o)l[n].call(m,m,e)}else{let o=e.column.key||e.col.key;l[o]&&e.row&&e.row.id&&l[o].call(m,m,e)}}}function et(e,t){t.isModalData||ie(e,t)}function tt(e){return"online_"+e+":"}function lt(e,t){return P(this,null,function*(){if(!s||!s.onlChange||!e)return!1;let l=s.onlChange();if(l[e]){let o={row:yield X(),column:{key:e},value:t};l[e].call(m,m,o)}})}function ce(e){let t=e.toLocaleString().match(Lt);if(t.length>1){let l=t[1];Oe(l)}}function Y(e,t){if(e=="js"){let l=t+"_hook";s&&s[t]?s[t].call(m,m):s&&s[l]&&ce(s[l])}else if(e=="action"){let l=v.value,o={formId:r.id,buttonCode:t,dataId:l.id,uiFormData:Object.assign({},l)};te.post({url:`${le.urlButtonAction}`,params:o},{isTransformResponse:!1}).then(n=>{n.success?i.success("处理完成!"):i.warning("处理失败!")})}}function pe(e){let t=g(e),l=[...t.getNewDataWithId(),...U.value[e]];if(!l||l.length==0)return!1;let o=[];for(let n of l)o.push(n.id);t.removeRowsById(o)}function fe(e,t){if(!t)return!1;let l=g(e);typeof t=="object"?l.addRows(t,!0):this.$message.error("添加子表数据,参数不识别!")}function ot(e,t){pe(e),fe(e,t)}function nt(e,t){!t&&t.length<=0&&(t=[]),t.map(l=>{l.hasOwnProperty("label")||(l.label=l.text)}),Q({field:e,componentProps:{options:t}})}function at(e,t){return s&&s.beforeSubmit?s.beforeSubmit(e,t):Promise.resolve()}function it(e,t){let l=D(B);e&&e.length>0?Object.keys(l).map(o=>{!o.endsWith("_load")&&e.indexOf(o)<0&&(B[o]=!1)}):t&&t.length>0&&Object.keys(l).map(o=>{t.indexOf(o)>=0&&(B[o]=!1)})}function rt(e,t){return P(this,null,function*(){F.value=t,yield ne(),v.value="",c.value=!0,yield re(e),yield ye(()=>{Y("js","loaded")})})}function g(e){let t=Z[e].value;if(t instanceof Array&&(t=t[0]),!t){i.warning("子表ref找不到:"+e);return}return t}function ut(){let e=V.reportPrintUrl,t=v.value.id,l=Ft();kt(e,t,l)}const[st,{openModal:be}]=qt(),G=p(""),ee=p(!0);function dt(e){G.value=e.id,ee.value=!1,be(!0,{isUpdate:!1,tableType:"3"})}function mt(e){let t=g(e.key).getSelectedData();if(t.length!=1){i.warning("请选择一条数据");return}G.value=e.id,ee.value=!1,be(!0,{isUpdate:!0,record:t[0]})}function ct(e){const t=e[ve];let l=Fe(e,[ve]);if(l.id){let o=Fe(M({},l),"id"),n=[{rowKey:l.id,values:o}];g(t).setValues(n)}else g(t).addRows(l,{isOnlineJS:!1,setActive:!1,emitChange:!0,isModalData:!0})}function pt(){if(r.themeTemplate===W)return;let e=$.value;if(e&&e.length>0){for(let t of e)if(t.relationType!=1){let l=g(t.key);l&&l.clearSelection()}}}function ft(){let e=X(),t=D(j[u.value]);H(t,l=>{T(l)},e)}function bt(e,t){let l=$.value;if(l&&l.length>0){let o=l.filter(n=>n.key===e);if(o.length==0)return;if(o[0].relationType==1)g(e).executeFillRule();else{let n=D(j[e]),b=D(t.row);H(n,x=>{const{row:q,target:ht}=t;let gt=[{rowKey:q.id,values:M({},x)}];ht.setValues(gt)},b)}}}let he={tableName:u,loading:S,subActiveKey:I,onlineFormRef:a,getFieldsValue:X,setFieldsValue:T,submitFlowFlag:f,subFormHeight:de,subTableHeight:me,refMap:Z,triggleChangeValues:ze,triggleChangeValue:Ze,sh:B,clearSubRows:pe,addSubRows:fe,clearThenAddRows:ot,changeOptions:nt,isUpdate:c,getSubTableInstance:g,updateSchema:Q,executeMainFillRule:ft,executeSubFillRule:bt,changEvent:()=>{},onlineFormValueChange:Ke};return z(he),{tableName:u,onlineFormRef:a,registerForm:xe,loading:S,subActiveKey:I,hasSubTable:Te,subTabInfo:$,refMap:Z,subFormHeight:de,getSubTableForeignKeyValue:Qe,isUpdate:c,handleSubFormChange:Ye,subTableHeight:me,onlineFormDisabled:ae,subDataSource:U,getSubTableAuthPre:tt,handleAdded:et,handleSubTableDefaultValue:ie,handleValueChange:Ge,openSubFormModalForAdd:dt,openSubFormModalForEdit:mt,show:De,createRootProperties:Ee,handleSubmit:Ue,sh:B,handleCgButtonClick:Y,handleCustomFormSh:it,handleCustomFormEdit:rt,dbData:v,onOpenReportPrint:ut,onlineExtConfigJson:V,registerPopModal:st,popTableName:G,getPopFormData:ct,popModalRequest:ee,onCloseModal:pt,ERP:W}}},Yt=["id"],Gt={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},el={key:1};function tl(r,d,i,a,R,S){const C=y("PrinterOutlined"),F=y("BasicForm"),f=y("online-sub-form"),c=y("diff-outlined"),O=y("a-button"),V=y("form-outlined"),m=y("JVxeTable"),z=y("a-tab-pane"),A=y("a-tabs"),j=y("Loading"),N=y("online-pop-modal");return k(),E("div",{id:a.tableName+"_form"},[a.dbData.id&&a.onlineExtConfigJson.reportPrintShow?(k(),E("div",Gt,[w(C,{title:"打印",onClick:a.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):J("",!0),w(F,{ref:"onlineFormRef",onRegister:a.registerForm},null,8,["onRegister"]),i.themeTemplate!==a.ERP&&a.hasSubTable?(k(),L(A,{key:1,activeKey:a.subActiveKey,"onUpdate:activeKey":d[0]||(d[0]=u=>a.subActiveKey=u)},{default:_(()=>[(k(!0),E(Ct,null,Ot(a.subTabInfo,(u,v)=>(k(),L(z,{tab:u.describe,key:v+"",forceRender:!0},{default:_(()=>[u.relationType==1?(k(),E("div",{key:0,style:xt({"overflow-y":"auto","overflow-x":"hidden","max-height":a.subFormHeight+"px"})},[w(f,{ref_for:!0,ref:a.refMap[u.key],table:u.key,disabled:a.onlineFormDisabled,"form-template":i.formTemplate,"main-id":a.getSubTableForeignKeyValue(u.foreignKey),properties:u.properties,"required-fields":u.requiredFields,"is-update":a.isUpdate,onFormChange:h=>a.handleSubFormChange(h,u.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(k(),E("div",el,[w(m,{ref_for:!0,ref:a.refMap[u.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:a.subTableHeight,disabled:a.onlineFormDisabled,columns:u.columns,dataSource:a.subDataSource[u.key],onValueChange:h=>a.handleValueChange(h,u.key),authPre:a.getSubTableAuthPre(u.key),onAdded:h=>a.handleAdded(u,h),onExecuteFillRule:h=>a.handleSubTableDefaultValue(u,h)},{toolbarSuffix:_(()=>[a.onlineFormDisabled?J("",!0):(k(),L(O,{key:0,type:"primary",onClick:h=>a.openSubFormModalForAdd(u)},{default:_(()=>[w(c)]),_:2},1032,["onClick"])),a.onlineFormDisabled?J("",!0):(k(),L(O,{key:1,type:"primary",onClick:h=>a.openSubFormModalForEdit(u)},{default:_(()=>[w(V)]),_:2},1032,["onClick"]))]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):J("",!0),w(j,{loading:a.loading,absolute:!1},null,8,["loading"]),Rt(r.$slots,"bottom"),w(N,{formTableType:"3",request:a.popModalRequest,id:a.popTableName,onRegister:a.registerPopModal,onSuccess:a.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,Yt)}const go=St(Xt,[["render",tl]]);export{go as default};
